<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניהול עסקית מתקדמת</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- Authentication check -->
    <script src="public/auth-check.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <button id="settingsHeaderBtn" class="settings-btn" onclick="openSettings()">⚙️ הגדרות</button>
            <h1>🏢 מערכת ניהול עסקית מתקדמת</h1>
            <p>ניהול הוצאות, תמחור מוצרים ומעקב הזמנות</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab" onclick="switchTab('expenses')">💰 הכנסות והוצאות</button>
            <button class="nav-tab" onclick="switchTab('pricing')">💎 תמחור מוצרים</button>
            <button class="nav-tab" onclick="switchTab('orders')">📦 ניהול הזמנות</button>
        </div>

        <div class="content">
            <!-- Settings Section -->
            <div id="settings" class="section">
                <div class="settings-panel">
                    <style>
                      /* Scoped to settings panel only */
                      .settings-panel .cat-card { border:1px solid #e3e6ea; border-radius:10px; margin:10px 0; overflow:hidden; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,0.05); }
                      .settings-panel .cat-header { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 12px; background:#f2f6fb; font-weight:700; color:#22324d; }
                      .settings-panel .subcard { border:1px solid #eef0f2; border-radius:8px; margin:8px 0; background:#fff; box-shadow:0 1px 1px rgba(0,0,0,0.04); }
                      .settings-panel .sub-header { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 10px; background:#f8fafc; font-weight:600; color:#22324d; }
                      .settings-panel .sum-badge { background:#f5f5f5; color:#333; border:1px solid #ddd; border-radius:999px; padding:2px 10px; font-weight:700; min-width:64px; text-align:center; }
                      .settings-panel .pill { border-radius:999px; padding:2px 8px; border:1px solid #ddd; background:#fff; font-weight:500; }
                      .settings-panel .icon-btn { all:unset; cursor:pointer; padding:4px 8px; border-radius:8px; color:#333; }
                      .settings-panel .icon-btn:hover { background:#f0f0f0; }
                      .settings-panel .row { display:flex; align-items:center; gap:8px; padding:4px 0; flex-wrap:nowrap; }
                      .settings-panel .row > * { flex:0 0 auto; }
                      .settings-panel .row input[type="text"]{ flex:0 1 220px; min-width:150px; padding:6px 8px; border:1px solid #ddd; border-radius:6px; background:#fff; }
                      .settings-panel .row input[type="number"] { flex:0 0 100px; min-width:90px; padding:6px 8px; border:1px solid #ddd; border-radius:6px; background:#fff; }
                      .settings-panel .row strong { display:inline-block; min-width:110px; white-space:nowrap; color:#555; }
                      .settings-panel .card-body { padding:8px 12px; overflow-x:auto; }
                      .settings-panel details { border:0; }
                    </style>
                    <h2>הגדרות מערכת</h2>
                    
                    <div class="settings-section">
                        <h3>ניהול קטגוריות</h3>
                        <div id="categoriesManager">
                            <div class="settings-row" style="justify-content: space-between; align-items: center; gap:8px;">
                                <div>
                                    <button id="addCategoryBtn" type="button">➕ הוסף קטגוריה</button>
                                    <button id="resetCategoriesBtn" type="button" style="margin-right:8px">↩️ אפס קטגוריות</button>
                                </div>
                                <div style="display:flex; gap:8px; align-items:center;">
                                    <small id="settingsDirty" style="color:#b30000; display:none;">• יש שינויים שלא נשמרו</small>
                                    <span id="settingsSaved" style="color: green; display: none;">✅ נשמר!</span>
                                    <button id="cancelSettingsBtn" type="button">בטל שינויים</button>
                                    <button id="saveSettingsBtn" type="button" style="background:#0b7; color:#fff;">שמור הגדרות</button>
                                </div>
                            </div>
                            <div id="categoriesList"></div>
                        </div>
                    </div>
                    
                </div>
            </div>

            <!-- Expenses Section -->
            <div id="expenses" class="section">
                <div class="filters">
                    <div class="filter-group">
                        <label>שנה:</label>
                        <select id="expenseYear" onchange="loadExpenseData()">
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>חודש:</label>
                        <select id="expenseMonth" onchange="loadExpenseData()">
                            <option value="0">כל השנה</option>
                            <option value="1">ינואר</option>
                            <option value="2">פברואר</option>
                            <option value="3">מרץ</option>
                            <option value="4">אפריל</option>
                            <option value="5">מאי</option>
                            <option value="6">יוני</option>
                            <option value="7">יולי</option>
                            <option value="8">אוגוסט</option>
                            <option value="9">ספטמבר</option>
                            <option value="10">אוקטובר</option>
                            <option value="11">נובמבר</option>
                            <option value="12">דצמבר</option>
                        </select>
                    </div>
                    <button onclick="showAddExpenseModal()">➕ הוסף רשומה</button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalIncome">₪0</div>
                        <div class="stat-label">סה"כ הכנסות</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalExpenses">₪0</div>
                        <div class="stat-label">סה"כ הוצאות</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="netProfit">₪0</div>
                        <div class="stat-label">רווח נקי</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="profitMargin">0%</div>
                        <div class="stat-label">אחוז רווח</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalSalaryFromHours">₪0</div>
                        <div class="stat-label">משכורת מחושבת</div>
                    </div>
                </div>



                <div class="card">
                    <div class="card-header">רשימת הכנסות והוצאות</div>
                    <table id="expenseTable">
                        <thead>
                            <tr>
                                <th>תאריך</th>
                                <th>סוג</th>
                                <th>קטגוריה</th>
                                <th>תיאור</th>
                                <th>סכום</th>
                                <th>שעות עבודה</th>
                                <th>חוזר</th>
                                <th>פעולות</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Pricing Section -->
            <div id="pricing" class="section">
                <!-- Compact Collections Manager -->
                <div class="card" style="margin-bottom:10px;">
                    <div class="card-header" style="padding:6px 10px; font-size:14px; cursor:pointer;" onclick="toggleCollectionsManager()">
                        <span id="collectionsToggleIcon">▶</span> ניהול קולקציות
                    </div>
                    <div id="collectionsManagerContent" class="card-body" style="padding:8px 10px; display:none;">
                        <div class="form-row">
                            <div>
                                <label>שם קולקציה חדשה:</label>
                                <input type="text" id="newCollectionName" placeholder="לדוגמה: קלאסית" style="height:28px;"/>
                            </div>
                            <div>
                                <button type="button" class="btn-small" onclick="addCollection()" style="margin-top:16px;">➕ הוסף קולקציה</button>
                            </div>
                        </div>
                        <div id="collectionsManagerList" style="margin-top:6px; font-size:13px;"></div>
                        <small style="color:#666; display:block; margin-top:4px;">מחיקה/עריכה משפיעה מיידית על כל העמוד.</small>
                    </div>
                </div>

                <!-- Top: New Product Pricing Calculator -->
                <div class="card">
                    <div class="card-header" style="cursor:pointer;" onclick="togglePricingCalculator()">
                        <span id="pricingToggleIcon">▶</span> חישוב תמחור מוצר חדש
                    </div>
                    <div id="pricingCalculatorContent" style="display:none;">
                    
                    <div class="form-row">
                        <div>
                            <label>סוג מוצר:</label>
                            <select id="productType">
                                <option value="טבעת">טבעת</option>
                                <option value="עגילים">עגילים</option>
                                <option value="שרשרת">שרשרת</option>
                                <option value="צמיד">צמיד</option>
                            </select>
                        </div>
                        <div>
                            <label>שם התכשיט:</label>
                            <input type="text" id="productName" placeholder="לדוגמה: טבעת ליאן"/>
                        </div>
                        <div>
                            <label>חומר:</label>
                            <select id="material" onchange="updatePricing()">
                                <option value="כסף">כסף</option>
                                <option value="יציקה כסף">יציקה כסף</option>
                                <option value="זהב 14K">זהב 14K</option>
                                <option value="ציפוי זהב">ציפוי זהב</option>
                                <option value="יציקה ציפוי זהב">יציקה ציפוי זהב</option>
                            </select>
                        </div>
                        <div>
                            <label>משקל (גרם):</label>
                            <input type="number" id="weight" step="0.1" onchange="updatePricing()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div style="min-width:260px; width:100%;">
                            <label>קולקציות:</label>
                            <div id="collectionsChecklist"></div>
                        </div>
                    </div>

                    <div class="price-display" style="margin-top:8px;">
                        <div class="price-item"><strong>שלב א' – הוצאות חומרים</strong></div>
                        <div class="price-item">
                            <span>עלות חומר:</span>
                            <span id="materialCost">₪0</span>
                        </div>
                        <div class="price-item" style="font-size:12px; color:#555;">
                            <span id="materialFormula">(סוג החומר × משקל החומר)</span>
                        </div>
                        <div class="price-item"><strong>שלב ב' – הוצאות כללי</strong></div>
                        <div class="card" style="margin:8px 0;">
                            <div class="card-header">תוספות</div>
                            <div class="card-body" id="additionsList"></div>
                            <div style="padding:8px 12px;">
                                <button type="button" class="btn-small" onclick="addAdditionRow()">➕ הוסף תוספת</button>
                            </div>
                        </div>
                        <div class="price-item">
                            <span>סכום תוספות:</span>
                            <span id="additionsSum">₪0</span>
                        </div>
                        <div class="price-item">
                            <span>הוצאות כללי:</span>
                            <span id="generalExpenses">₪0</span>
                        </div>
                        <div class="price-item" style="font-size:12px; color:#555;">
                            <span id="generalFormula">(הוצאות חומרים + Σ תוספות + קבועי תמחור תכשיטים)</span>
                        </div>
                        <div class="price-item"><strong>שלב ג' – הוצאות ועבודה</strong></div>
                        <div class="price-item">
                            <span>הוצאות ועבודה:</span>
                            <span id="workAndExpenses">₪0</span>
                        </div>
                        <div class="price-item" style="font-size:12px; color:#555;">
                            <span id="workFormula">(הוצאות כללי + (זמן עבודה × שעת עבודה))</span>
                        </div>
                        <div class="price-item">
                            <label for="additionalWorkHours">שעות עבודה נוספות:</label>
                            <input type="number" id="additionalWorkHours" min="0" step="0.5" value="0" onchange="updatePricing()" style="width: 80px; margin-right: 10px;">
                            <span style="font-size: 12px; color: #666;">שעות</span>
                        </div>
                        <div class="price-item"><strong>שלב ד' – הוצאות סופי</strong></div>
                        <div class="price-item">
                            <span>הוצאות סופי:</span>
                            <span id="finalExpenses">₪0</span>
                        </div>
                        <div class="price-item" style="font-size:12px; color:#555;">
                            <span id="finalFormula">(הוצאות ועבודה × מכפלת כל העמלות)</span>
                        </div>
                        <div class="price-item"><strong>שלב ה' – מחיר מחושב סופי</strong></div>
                        <div class="price-item" style="background:#f0f8ff; padding:8px; border-radius:6px; border:2px solid #0066cc;">
                            <span style="font-size:18px; font-weight:bold;">מחיר מומלץ:</span>
                            <span id="recommendedPrice" style="font-size:20px; font-weight:bold; color:#0066cc;">₪0</span>
                        </div>
                        <div class="price-item" style="font-size:12px; color:#555;">
                            <span id="priceFormula">(הוצאות סופי × מכפלת רווח)</span>
                        </div>
                        <div class="price-item">
                            <span>רווח מומלץ:</span>
                            <span><strong id="recommendedProfitMoney">₪0</strong> (<span id="recommendedProfitPercent">0%</span>)</span>
                        </div>
                    </div>

                    <div class="form-row" style="margin-top:12px; align-items:center;">
                        <div>
                            <label>מחיר באתר:</label>
                            <input type="number" id="sitePriceInput" step="0.01" placeholder="ברירת מחדל: מחיר מומלץ" onchange="calculateDiscount()">
                            <small style="display:block;color:#666;">אם לא שינית – יישמר המחיר המומלץ</small>
                        </div>
                        <div class="price-item" style="margin-inline-start:16px;">
                            <span>רווח באתר:</span>
                            <span><strong id="siteProfitMoney">₪0</strong> (<span id="siteProfitPercent">0%</span>)</span>
                        </div>
                        <div>
                            <button onclick="addToProducts()" style="margin-top:18px;">➕ שמור והוסף לרשימת המוצרים</button>
                        </div>
                    </div>

                    <!-- Formulas now shown inline next to each step -->
                    </div>
                </div>

                <!-- Middle: Discounts and Filters -->
                <div class="card">
                    <div class="card-header">בדיקת מחירים והנחות + סינון</div>
                    <div class="form-row">
                        <div>
                            <label>הנחה כללית (%):</label>
                            <input type="number" id="listDiscountPercent" min="0" max="100" value="0" onchange="loadProducts()" />
                        </div>
                        <div>
                            <label>סוג מוצר:</label>
                            <select id="filterType" onchange="loadProducts()">
                                <option value="">הכל</option>
                                <option value="טבעת">טבעת</option>
                                <option value="עגילים">עגילים</option>
                                <option value="שרשרת">שרשרת</option>
                                <option value="צמיד">צמיד</option>
                            </select>
                        </div>
                        <div>
                            <label>חומר:</label>
                            <select id="filterMaterial" onchange="loadProducts()">
                                <option value="">הכל</option>
                                <option value="כסף">כסף</option>
                                <option value="יציקה כסף">יציקה כסף</option>
                                <option value="זהב 14K">זהב 14K</option>
                                <option value="ציפוי זהב">ציפוי זהב</option>
                                <option value="יציקה ציפוי זהב">יציקה ציפוי זהב</option>
                                <option value="exclude_14k">הכל חוץ מזהב 14K</option>
                            </select>
                        </div>
                        <div>
                            <label>קולקציה:</label>
                            <select id="filterCollection" onchange="loadProducts()">
                                <option value="">הכל</option>
                            </select>
                        </div>
                        <div style="min-width:220px;">
                            <label>חיפוש שם ספציפי:</label>
                            <input type="text" id="filterName" placeholder="שם התכשיט" oninput="loadProducts()" />
                        </div>
                    </div>
                </div>

                <!-- Bottom: Products List -->
                <div class="card">
                    <div class="card-header">רשימת מוצרים</div>
                    <table id="productsTable">
                        <thead>
                            <tr>
                                <th class="row-number-header">#</th>
                                <th>סוג</th>
                                <th>שם</th>
                                <th>חומר</th>
                                <th>קולקציה</th>
                                <th>סה"כ הוצאות</th>
                                <th>מחיר מינימלי מומלץ (30%)</th>
                                <th class="site-price-header">💰 מחיר באתר</th>
                                <th>מחיר אחרי הנחה</th>
                                <th>רווח (₪)</th>
                                <th>רווח (%)</th>
                                <th>פעולות</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Orders Section -->
            <div id="orders" class="section">
                <div class="filters">
                    <div class="filter-group">
                        <label>חודש:</label>
                        <select id="orderMonth" onchange="loadOrders()">
                            <option value="0">כל החודשים</option>
                            <option value="1">ינואר</option>
                            <option value="2">פברואר</option>
                            <option value="3">מרץ</option>
                            <option value="4">אפריל</option>
                            <option value="5">מאי</option>
                            <option value="6">יוני</option>
                            <option value="7">יולי</option>
                            <option value="8">אוגוסט</option>
                            <option value="9">ספטמבר</option>
                            <option value="10">אוקטובר</option>
                            <option value="11">נובמבר</option>
                            <option value="12">דצמבר</option>
                        </select>
                    </div>
                    <button onclick="showAddOrderModal()">➕ הזמנה חדשה</button>
                    <button onclick="toggleCompletedOrders()" id="toggleCompletedBtn">📋 הצג הזמנות מושלמות</button>
                </div>

                <div class="card">
                    <div class="card-header">ניהול הזמנות</div>
                    <table id="ordersTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>מספר הזמנה</th>
                                <th>תאריך</th>
                                <th>לקוח</th>
                                <th>מוצרים</th>
                                <th>סכום</th>
                                <th>קבלה</th>
                                <th>סטטוס</th>
                                <th>פעולות</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Completed Orders Section -->
                <div id="completedOrdersSection" class="card" style="display: none; margin-top: 20px;">
                    <div class="card-header">הזמנות מושלמות</div>
                    <table id="completedOrdersTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>מספר הזמנה</th>
                                <th>תאריך</th>
                                <th>לקוח</th>
                                <th>מוצרים</th>
                                <th>סכום</th>
                                <th>תאריך השלמה</th>
                                <th>פעולות</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="addExpenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">הוספת רשומה חדשה</div>
            <form id="addExpenseForm">
                <div class="form-group">
                    <label>סוג:</label>
                    <select id="expenseType" required onchange="toggleWorkHoursField()">
                        <option value="income">הכנסה</option>
                        <option value="expense">הוצאה</option>
                    </select>
                </div>
                <!-- For Income: Category selection -->
                <div class="form-group" id="categoryGroup">
                    <label>קטגוריה:</label>
                    <select id="expenseCategory">
                        <option value="">בחר קטגוריה</option>
                        <option value="sales">מכירות</option>
                        <option value="other">אחר</option>
                    </select>
                </div>
                <!-- For Expense: Fixed/Variable selection -->
                <div class="form-group" id="expenseSubtypeGroup" style="display: none;">
                    <label>סוג הוצאה:</label>
                    <select id="expenseSubtype" onchange="toggleRecurringBySubtype()">
                        <option value="fixed">הוצאה קבועה</option>
                        <option value="variable">הוצאה משתנה</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>תיאור:</label>
                    <input type="text" id="expenseDescription" required>
                </div>
                <div class="form-group">
                    <label>סכום:</label>
                    <input type="number" id="expenseAmount" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>תאריך:</label>
                    <input type="date" id="expenseDate" required>
                </div>
                <div class="form-group" id="workHoursGroup" style="display: none;">
                    <label>שעות עבודה:</label>
                    <input type="number" id="expenseWorkHours" min="0" step="0.5" placeholder="הכנס מספר שעות">
                </div>
                <div class="form-group" id="recurringGroup" style="display: none;">
                    <label>
                        <input type="checkbox" id="isRecurring" onchange="toggleRecurringMonths()">
                        הוצאה חוזרת חודשית
                    </label>
                </div>
                <div class="form-group" id="recurringMonths" style="display: none;">
                    <label>מספר חודשים לחזרה:</label>
                    <input type="number" id="recurringMonthsCount" min="1" max="24" value="12">
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="closeModal('addExpenseModal')" class="btn-secondary">ביטול</button>
                    <button type="button" onclick="addExpense(event)">הוסף</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editExpenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">עריכת רשומה</div>
            <form id="editExpenseForm">
                <input type="hidden" id="editExpenseId">
                <div class="form-group">
                    <label>סוג:</label>
                    <select id="editExpenseType" required onchange="toggleEditWorkHoursField()">
                        <option value="income">הכנסה</option>
                        <option value="expense">הוצאה</option>
                    </select>
                </div>
                <!-- For Income: Category selection -->
                <div class="form-group" id="editCategoryGroup">
                    <label>קטגוריה:</label>
                    <select id="editExpenseCategory">
                        <option value="">בחר קטגוריה</option>
                        <option value="sales">מכירות</option>
                        <option value="other">אחר</option>
                    </select>
                </div>
                <!-- For Expense: Fixed/Variable selection -->
                <div class="form-group" id="editExpenseSubtypeGroup" style="display: none;">
                    <label>סוג הוצאה:</label>
                    <select id="editExpenseSubtype" onchange="toggleEditRecurringBySubtype()">
                        <option value="fixed">הוצאה קבועה</option>
                        <option value="variable">הוצאה משתנה</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>תיאור:</label>
                    <input type="text" id="editExpenseDescription" required>
                </div>
                <div class="form-group">
                    <label>סכום:</label>
                    <input type="number" id="editExpenseAmount" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>תאריך:</label>
                    <input type="date" id="editExpenseDate" required>
                </div>
                <div class="form-group" id="editWorkHoursGroup" style="display: none;">
                    <label>שעות עבודה:</label>
                    <input type="number" id="editExpenseWorkHours" min="0" step="0.5" placeholder="הכנס מספר שעות">
                </div>
                <div class="form-group" id="editRecurringGroup" style="display: none;">
                    <label>
                        <input type="checkbox" id="editIsRecurring" onchange="toggleEditRecurringMonths()">
                        הוצאה חוזרת חודשית
                    </label>
                </div>
                <div class="form-group" id="editRecurringMonths" style="display: none;">
                    <label>מספר חודשים לחזרה:</label>
                    <input type="number" id="editRecurringMonthsCount" min="1" max="24" value="12">
                </div>
                <!-- Edit scope options for recurring expenses -->
                <div class="form-group" id="editScopeGroup" style="display: none;">
                    <label>החל שינויים על:</label>
                    <select id="editScope">
                        <option value="single">רק רשומה זו</option>
                        <option value="all">כל החזרות</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="closeModal('editExpenseModal')" class="btn-secondary">ביטול</button>
                    <button type="button" onclick="saveEditedExpense(event)">עדכן</button>
                </div>
            </form>
        </div>
    </div>

    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">הוספת מוצר חדש</div>
            <form id="addProductForm">
                <div class="form-group">
                    <label>סוג מוצר:</label>
                    <select id="newProductType" required>
                        <option value="">בחר סוג</option>
                        <option value="טבעת">טבעת</option>
                        <option value="עגילים">עגילים</option>
                        <option value="שרשרת">שרשרת</option>
                        <option value="צמיד">צמיד</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>שם דגם:</label>
                    <input type="text" id="newProductName" required>
                </div>
                <div class="form-group">
                    <label>חומר:</label>
                    <select id="newProductMaterial" required>
                        <option value="">בחר חומר</option>
                        <option value="14K זהב">14K זהב</option>
                        <option value="כסף">כסף</option>
                        <option value="כסף יציקה">כסף יציקה</option>
                        <option value="ציפוי- כסף">ציפוי כסף</option>
                        <option value="ציפוי- יציקה">ציפוי יציקה</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>עלות ייצור:</label>
                    <input type="number" id="newProductCost" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>מחיר מחושב:</label>
                    <input type="number" id="newProductPrice" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>מחיר באתר:</label>
                    <input type="number" id="newProductSitePrice" min="0" step="0.01" required>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="closeModal('addProductModal')" class="btn-secondary">ביטול</button>
                    <button type="submit">הוסף מוצר</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">עריכת מוצר</div>
            <form id="editProductForm">
                <input type="hidden" id="editProductId">
                <div class="form-group">
                    <label>סוג מוצר:</label>
                    <select id="editProductType" required onchange="updateEditPricing()">
                        <option value="">בחר סוג</option>
                        <option value="טבעת">טבעת</option>
                        <option value="עגילים">עגילים</option>
                        <option value="שרשרת">שרשרת</option>
                        <option value="צמיד">צמיד</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>שם התכשיט:</label>
                    <input type="text" id="editProductName" required>
                </div>
                <div class="form-group">
                    <label>חומר:</label>
                    <select id="editProductMaterial" required onchange="updateEditPricing(true)">
                        <option value="">בחר חומר</option>
                        <option value="כסף">כסף</option>
                        <option value="זהב 14K">זהב 14K</option>
                        <option value="ציפוי זהב">ציפוי זהב</option>
                        <option value="יציקה כסף">יציקה כסף</option>
                        <option value="יציקה ציפוי זהב">יציקה ציפוי זהב</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>משקל (גרם):</label>
                    <input type="number" id="editProductWeight" step="0.1" onchange="updateEditPricing(true)">
                </div>
                <div class="form-group">
                    <label>קולקציות:</label>
                    <div id="editCollectionsChecklist"></div>
                </div>
                <div class="form-group">
                    <label>תוספות:</label>
                    <div id="editAdditionsList"></div>
                    <button type="button" class="btn-small" onclick="addEditAdditionRow()">➕ הוסף תוספת</button>
                </div>
                <div class="form-group">
                    <label>מחיר מומלץ מחושב:</label>
                    <div id="editRecommendedPrice" style="font-size:16px; font-weight:bold; color:#0066cc;">₪0</div>
                </div>
                <div class="form-group">
                    <label>מחיר באתר:</label>
                    <input type="number" id="editProductSitePrice" min="0" step="0.01" required>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="closeModal('editProductModal')" class="btn-secondary">ביטול</button>
                    <button type="button" onclick="saveEditedProductClick()">עדכן מוצר</button>
                </div>
            </form>
        </div>
    </div>

    <div id="addOrderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">הזמנה חדשה</div>
            <form id="addOrderForm">
                <div class="form-group">
                    <label>שם הלקוח:</label>
                    <input type="text" id="customerName" required>
                </div>
                
                <div class="form-group">
                    <label>תאריך הזמנה:</label>
                    <input type="date" id="orderDate" required>
                </div>
                
                <div class="form-group">
                    <label>מוצרים:</label>
                    <div class="products-selection">
                        <div class="products-input-container">
                            <input type="text" id="productSearchInput" placeholder="חפש מוצר מהרשימה או הקלד ידנית..." autocomplete="off">
                            <div id="productSuggestions" class="product-suggestions" style="display: none;"></div>
                        </div>
                        <button type="button" id="addProductBtn" class="btn-small">➕ הוסף מוצר</button>
                        <div id="selectedProductsList" class="selected-products-list"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>סכום כולל:</label>
                    <div class="amount-container">
                        <input type="number" id="calculatedAmount" min="0" step="0.01" readonly style="background-color: #f5f5f5;">
                        <span class="amount-note">מחושב אוטומטית מהמוצרים</span>
                    </div>
                </div>
                
                <div class="form-group discount-section" style="border: 1px solid #ddd; padding: 10px; border-radius: 4px; background-color: #f9f9f9;">
                    <label>
                        <input type="checkbox" id="hasDiscount">
                        ניתנה הנחה
                    </label>
                    <div id="discountDetails" style="display: none; margin-top: 10px;">
                        <div class="form-group">
                            <label>מחיר סופי ששולם:</label>
                            <input type="number" id="finalPaidAmount" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>סיבת ההנחה:</label>
                            <textarea id="discountReason" rows="2" placeholder="למה ניתנה הנחה?"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="receiptSent">
                        קבלה נשלחה
                    </label>
                </div>
                
                <div class="form-group">
                    <label>הערות:</label>
                    <textarea id="orderNotes" rows="2"></textarea>
                </div>
                
                <div class="modal-footer">
                    <button type="button" onclick="closeModal('addOrderModal')" class="btn-secondary">ביטול</button>
                    <button type="button" onclick="addOrderClick()">הוסף הזמנה</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editOrderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">עריכת הזמנה</div>
            <form id="editOrderForm" onsubmit="return saveEditedOrder(event)">
                <div class="form-group">
                    <label>שם הלקוח:</label>
                    <input type="text" id="editCustomerName" required>
                </div>
                
                <div class="form-group">
                    <label>תאריך הזמנה:</label>
                    <input type="date" id="editOrderDate" required>
                </div>
                
                <div class="form-group">
                    <label>מוצרים:</label>
                    <div class="products-selection">
                        <div class="product-search-container">
                            <input type="text" id="editProductSearchInput" placeholder="חפש מוצר קיים או הכנס שם מוצר חדש...">
                            <div id="editProductSuggestions" class="product-suggestions" style="display: none;"></div>
                            <button type="button" id="editAddProductBtn">➕ הוסף מוצר</button>
                        </div>
                        <div id="editSelectedProductsList" class="selected-products-list"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>סכום כולל:</label>
                    <div class="amount-container">
                        <input type="number" id="editCalculatedAmount" min="0" step="0.01" readonly style="background-color: #f5f5f5;">
                        <span class="amount-note">מחושב אוטומטית מהמוצרים</span>
                    </div>
                </div>
                
                <div class="form-group discount-section" style="border: 1px solid #ddd; padding: 10px; border-radius: 4px; background-color: #f9f9f9;">
                    <label>
                        <input type="checkbox" id="editHasDiscount" onchange="orderManager.toggleEditDiscountSection(this.checked)">
                        ניתנה הנחה
                    </label>
                    <div id="editDiscountDetails" style="display: none; margin-top: 10px;">
                        <div class="form-group">
                            <label>מחיר סופי ששולם:</label>
                            <input type="number" id="editFinalPaidAmount" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>סיבת ההנחה:</label>
                            <textarea id="editDiscountReason" rows="2" placeholder="למה ניתנה הנחה?"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="editReceiptSent">
                        קבלה נשלחה
                    </label>
                </div>
                
                <div class="form-group">
                    <label>הערות:</label>
                    <textarea id="editOrderNotes" rows="2"></textarea>
                </div>
                
                <div class="modal-footer">
                    <button type="button" onclick="closeModal('editOrderModal')" class="btn-secondary">ביטול</button>
                    <button type="submit">שמור שינויים</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modular core and domain scripts (placeholders) -->
    <script src="js/core/constants.js"></script>
    <script src="js/core/utils/date.util.js"></script>
    <script src="js/core/utils/currency.util.js"></script>
    <script src="js/core/utils/dom.util.js"></script>
    <script src="js/core/storage/storage.service.js"></script>
    <script src="js/core/storage/settings.service.js"></script>
    <script src="js/glue/app.state.js"></script>
    <script src="js/domain/models/Expense.js"></script>
    <script src="js/domain/models/Product.js"></script>
    <script src="js/domain/models/Order.js"></script>
    <script src="js/domain/repositories/expense.repository.js"></script>
    <script src="js/domain/repositories/income.repository.js"></script>
    <script src="js/domain/repositories/product.repository.js"></script>
    <script src="js/domain/repositories/order.repository.js"></script>
    <script src="js/features/products/products.manager.js"></script>
    <script src="js/features/orders/orders.manager.js"></script>
    <script src="js/features/expenses/expenses.manager.js"></script>
    <script src="js/app.bootstrap.js"></script>
    <!-- Existing app remains the source of truth -->
    <script src="js/app.js"></script>

    <!-- Settings Categories Manager (scoped to settings page only) -->
    <script>
      (function(){
        // Defaults seeded per approved hierarchy (Hebrew)
        const DEFAULT_CATEGORIES = [
          { name: 'עמלות', collapsed: true, subcategories: [], items: [
              { name: 'מקדם עמלת הוצאות קבועות', value: 1.17 },
              { name: 'מקדם עמלת סליקה (5.7%)', value: 1.057 },
              { name: 'מע"מ', value: 1.18 }
            ] },
          { name: 'קבועי תמחור תכשיטים', collapsed: true, subcategories: [
            { name: 'פירוט אריזה', collapsed: true, items: [
              { name: 'קופסאת תכשיט', value: 2.5, quantity: 100, manufacturer: 'גיל אריזות' },
              { name: 'קופסאת אריזה', value: 7.17, quantity: 50, manufacturer: 'Geotobox' },
              { name: 'שקית נייר', value: 1.5, quantity: 100, manufacturer: 'ספק מקומי' },
              { name: 'מדבקה', value: 0.38, quantity: 200, manufacturer: 'ספק מקומי' },
              { name: 'נייר משי', value: 6.33, quantity: 50, manufacturer: 'ספק מקומי' }
              ] }
            ], items: [
              { name: 'סה"כ אריזה', value: 17.88 },
              { name: 'משלוח בארץ', value: 17 }
            ] },
          { name: 'מכפילי רווח', collapsed: true, subcategories: [], items: [
            { name: 'מכפלת זהב', value: 1.3 },
            { name: 'מכפלת כסף', value: 1.5 },
            { name: 'מכפלת ציפוי זהב', value: 1.5 },
            { name: 'מכפלת יציקה כסף', value: 1.5 },
            { name: 'מכפלת יציקה ציפוי זהב', value: 1.5 }
          ] },
          { name: 'יחסי המרה', collapsed: true, subcategories: [], items: [
            { name: 'זהב 14K', value: 13.4 },
            { name: 'כסף', value: 10.4 }
          ] },
          { name: 'חומרים – עלויות ועבודה', collapsed: true, subcategories: [
            { name: 'עלות חומרים לגרם', collapsed: true, items: [
              { name: 'כסף', value: 6 },
              { name: 'יציקה כסף', value: 9 },
              { name: 'זהב 14K', value: 270 },
              { name: 'ציפוי זהב', value: 10 },
              { name: 'יציקה ציפוי זהב', value: 10 }
            ] },
            { name: 'זמן עבודה (שעות)', collapsed: true, items: [
              { name: 'כסף', value: 1 },
              { name: 'יציקה כסף', value: 1 },
              { name: 'זהב 14K', value: 1.875 },
              { name: 'ציפוי זהב', value: 1 },
              { name: 'יציקה ציפוי זהב', value: 1 }
            ] }
          ], items: [
            { name: 'מחיר עבודה לשעה', value: 80 }
          ] },
          { name: 'הוצאות קבועות', collapsed: true, subcategories: [], items: [
            { name: 'סה"כ הוצאות קבועות', value: 0 },
            { name: 'שיווק', value: 500 },
            { name: 'רו"ח', value: 354 },
            { name: 'אתר – שופיפי', value: 160 },
            { name: 'ייעוץ/צילומים/כללי', value: 500 },
            { name: 'ביטוח לאומי', value: 659 },
            { name: 'ביטוח בריאות', value: 17.61 },
            { name: 'פנסיה', value: 305 },
            { name: 'יציקות', value: 0 },
            { name: 'חומר לתכשיטים חדשים', value: 0 },
            { name: 'iCount', value: 112 }
          ] }
        ];

        function getSettingsSafe(){
          // Use localStorage directly for sync access - MongoDB data is synced to localStorage
          try { return JSON.parse(localStorage.getItem('settings') || '{}'); } catch { return {}; }
        }

        async function setSettingsSafe(s){
          if (window.App?.SettingsService?.set) {
            await App.SettingsService.set(s);
            console.log('✅ Settings saved to MongoDB');
          } else {
            localStorage.setItem('settings', JSON.stringify(s||{}));
          }
        }

        // Data migration to new structure (subcategories => objects with items, allow category-level items)
        function normalize(categories){
          return (categories || []).map(c => ({
            name: c.name || 'קטגוריה',
            collapsed: !!c.collapsed,
            items: Array.isArray(c.items) ? c.items : [],
            subcategories: (c.subcategories || []).map(sc => {
              if (typeof sc === 'string') return { name: sc, collapsed: true, items: [] };
              return { name: sc.name || 'תת קטגוריה', collapsed: !!sc.collapsed, items: Array.isArray(sc.items) ? sc.items : [] };
            })
          }));
        }

        function ensureDefaultCategories(){
          const s = getSettingsSafe();
          if (!Array.isArray(s.categories) || s.categories.length === 0) {
            s.categories = DEFAULT_CATEGORIES;
            setSettingsSafe(s);
          } else {
            s.categories = normalize(s.categories);
            setSettingsSafe(s);
          }
          return s.categories;
        }

        // ---------- Helpers used by Settings rendering ----------
        function findCategory(categories, name){
          return (categories || []).find(c => (c.name||'') === name) || null;
        }

        function findSubcategory(cat, name){
          return (cat?.subcategories || []).find(s => (s.name||'') === name) || null;
        }

        function subSum(sub){
          const items = sub?.items || [];
          return items.reduce((acc, it) => acc + Number(it?.value || 0), 0);
        }

        function catSum(cat){
          const own = (cat?.items || []).reduce((acc, it) => acc + Number(it?.value || 0), 0);
          const subs = (cat?.subcategories || []).reduce((acc, s) => acc + subSum(s), 0);
          return own + subs;
        }

        // No-op migration hook (kept for future compatibility). Returns true if modified.
        function migratePricingCategoryStructure(categories){
          // In this version nothing to migrate. Ensure normalized shape only.
          return false;
        }

        // Ensure the computed packaging total item exists; return true if added/changed structure.
        function seedPackagingDefaults(categories){
          const pricingCat = findCategory(categories, 'קבועי תמחור תכשיטים');
          if (!pricingCat) return false;
          pricingCat.items = Array.isArray(pricingCat.items) ? pricingCat.items : [];
          const exists = pricingCat.items.find(it => (it.name||'') === 'סה"כ אריזה');
          if (!exists) {
            pricingCat.items.push({ name: 'סה"כ אריזה', value: 0 });
            return true;
          }
          return false;
        }

        // Ensure the computed fixed expenses total item exists; return true if added/changed structure.
        function seedFixedExpensesDefaults(categories){
          const fixedCat = findCategory(categories, 'הוצאות קבועות');
          if (!fixedCat) return false;
          fixedCat.items = Array.isArray(fixedCat.items) ? fixedCat.items : [];
          const exists = fixedCat.items.find(it => (it.name||'') === 'סה"כ הוצאות קבועות');
          if (!exists) {
            fixedCat.items.unshift({ name: 'סה"כ הוצאות קבועות', value: 0 });
            return true;
          }
          return false;
        }

        // Compute the packaging total from 'פירוט אריזה' and sync into category-level 'סה"כ אריזה'
        function syncPackagingTotal(categories){
          const pricingCat = findCategory(categories, 'קבועי תמחור תכשיטים');
          if (!pricingCat) return;
          const packSub = findSubcategory(pricingCat, 'פירוט אריזה');
          const total = packSub ? subSum(packSub) : 0;
          const totalItem = (pricingCat.items || []).find(it => (it.name||'') === 'סה"כ אריזה');
          if (totalItem) totalItem.value = parseFloat(total.toFixed(2));
        }

        // Compute the fixed expenses total and sync into category-level 'סה"כ הוצאות קבועות'
        function syncFixedExpensesTotal(categories){
          const fixedCat = findCategory(categories, 'הוצאות קבועות');
          if (!fixedCat) return;
          
          // Calculate sum of all items except the total item itself
          let total = 0;
          (fixedCat.items || []).forEach(item => {
            if (item.name !== 'סה"כ הוצאות קבועות') {
              total += Number(item.value || 0);
            }
          });
          
          const totalItem = (fixedCat.items || []).find(it => (it.name||'') === 'סה"כ הוצאות קבועות');
          if (totalItem) totalItem.value = parseFloat(total.toFixed(2));
        }

        // Draft/dirty management for Settings (categories)
        let __categoriesDraft = null;
        let __settingsDirty = false;

        function setSettingsDirty(flag){
          __settingsDirty = !!flag;
          try {
            const dirtyEl = document.getElementById('settingsDirty');
            const savedEl = document.getElementById('settingsSaved');
            if (dirtyEl) dirtyEl.style.display = __settingsDirty ? 'inline' : 'none';
            if (savedEl && __settingsDirty) savedEl.style.display = 'none';
          } catch{}
          window.onbeforeunload = __settingsDirty ? function(e){ e.preventDefault(); e.returnValue=''; return ''; } : null;
        }

        function markDirty(){ setSettingsDirty(true); }

        function getCategoriesForEdit(){
          if (__categoriesDraft) return __categoriesDraft;
          const base = ensureDefaultCategories();
          // Deep copy to isolate from persisted settings
          __categoriesDraft = JSON.parse(JSON.stringify(base));
          return __categoriesDraft;
        }

        function getCategoriesView(){
          return __categoriesDraft || ensureDefaultCategories();
        }

        async function commitCategories(){
          if (!__categoriesDraft) return;
          
          // Get current categories before saving changes
          const s = getSettingsSafe();
          const oldCategories = s.categories || {};
          
          // Save new categories
          s.categories = normalize(__categoriesDraft);
          await setSettingsSafe(s);
          
          // Detect which categories changed (added, removed, or modified)
          const changedCategories = detectChangedCategories(oldCategories, s.categories);
          
          __categoriesDraft = null;
          setSettingsDirty(false);
          try { const ok = document.getElementById('settingsSaved'); if (ok) { ok.style.display='inline'; setTimeout(()=>ok.style.display='none', 1200); } } catch{}
          renderCategories();
          
          // Refresh products display to reflect new settings
          if (window.refreshProductsAfterSettingsChange) {
            window.refreshProductsAfterSettingsChange(changedCategories);
          }
        }
        
        // Helper function to detect which categories have changed
        function detectChangedCategories(oldCategories, newCategories) {
          const changedCategories = new Set();
          
          console.log('🔍 Detecting category changes...');
          console.log('📋 Old categories:', Object.keys(oldCategories || {}));
          console.log('📋 New categories:', Object.keys(newCategories || {}));
          
          // Check all category names from both old and new
          const allCategoryNames = new Set([
            ...Object.keys(oldCategories || {}),
            ...Object.keys(newCategories || {})
          ]);
          
          for (const categoryName of allCategoryNames) {
            const oldCategory = oldCategories[categoryName];
            const newCategory = newCategories[categoryName];
            
            console.log(`🔎 Checking category: "${categoryName}"`);
            
            // Category was added or removed
            if (!oldCategory || !newCategory) {
              console.log(`➕➖ Category "${categoryName}" was ${!oldCategory ? 'added' : 'removed'}`);
              changedCategories.add(categoryName);
              continue;
            }
            
            // Check if items were added/removed/modified
            const oldJson = JSON.stringify(oldCategory);
            const newJson = JSON.stringify(newCategory);
            
            if (oldJson !== newJson) {
              console.log(`🔄 Category "${categoryName}" was modified`);
              console.log('📊 Old structure:', oldCategory);
              console.log('📊 New structure:', newCategory);
              changedCategories.add(categoryName);
            } else {
              console.log(`✅ Category "${categoryName}" unchanged`);
            }
          }
          
          console.log('🎯 Final detected changed categories:', Array.from(changedCategories));
          return Array.from(changedCategories);
        }

        function discardCategoryChanges(){
          __categoriesDraft = null;
          setSettingsDirty(false);
          renderCategories();
        }

        function renderCategories(){
          const container = document.getElementById('categoriesList');
          if (!container) return;
          const categories = getCategoriesForEdit();
          let migrated = migratePricingCategoryStructure(categories);
          if (seedPackagingDefaults(categories)) { migrated = true; }
          if (seedFixedExpensesDefaults(categories)) { migrated = true; }
          // Do not auto-save; user will decide to commit. Keep draft updated.
          syncPackagingTotal(categories);
          syncFixedExpensesTotal(categories);
          container.innerHTML = '';

          categories.forEach((cat, idx) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'cat-card';

            const header = document.createElement('div');
            header.className = 'cat-header';

            const left = document.createElement('div');
            left.style.display = 'flex'; left.style.alignItems = 'center'; left.style.gap = '8px';

            const titleBtn = document.createElement('button');
            titleBtn.type = 'button';
            titleBtn.className = 'icon-btn';
            titleBtn.textContent = cat.name || ('קטגוריה ' + (idx+1));
            titleBtn.addEventListener('click', () => {
              // UI-only toggle; should NOT mark settings as dirty
              cat.collapsed = !cat.collapsed; body.style.display = cat.collapsed ? 'none' : 'block';
            });

            left.appendChild(titleBtn);

            const actions = document.createElement('div');
            const addSubBtn = document.createElement('button'); addSubBtn.className='icon-btn'; addSubBtn.textContent='➕ תת-קטגוריה';
            addSubBtn.addEventListener('click', () => {
              const name = prompt('שם תת-קטגוריה חדשה:');
              if (!name || !name.trim()) return;
              cat.subcategories = cat.subcategories || [];
              cat.subcategories.push({ name: name.trim(), collapsed: true, items: [] });
              markDirty(); renderCategories();
            });

            const addCatItemBtn = document.createElement('button'); addCatItemBtn.className='icon-btn'; addCatItemBtn.textContent='➕ נתון קטגוריה'; addCatItemBtn.title='הוסף נתון ישירות לקטגוריה';
            addCatItemBtn.addEventListener('click', () => {
              const n = prompt('שם נתון חדש בקטגוריה:');
              if (!n || !n.trim()) return;
              const vStr = prompt('ערך מספרי (ניתן לעדכון לאחר מכן):', '0');
              const v = Number(vStr||0);
              cat.items = cat.items || [];
              cat.items.push({ name:n, value:v });
              markDirty(); renderCategories();
            });

            const editBtn = document.createElement('button'); editBtn.className='icon-btn'; editBtn.textContent='✏️'; editBtn.title='עריכת שם';
            editBtn.addEventListener('click', () => {
              const newName = prompt('שם קטגוריה חדש:', cat.name);
              if (newName && newName.trim()) { cat.name = newName.trim(); markDirty(); renderCategories(); }
            });

            const removeBtn = document.createElement('button'); removeBtn.className='icon-btn'; removeBtn.textContent='🗑️'; removeBtn.title='מחיקה';
            removeBtn.addEventListener('click', () => {
              if (confirm('למחוק את הקטגוריה?')) { categories.splice(idx,1); markDirty(); renderCategories(); }
            });

            actions.appendChild(addCatItemBtn); actions.appendChild(addSubBtn); actions.appendChild(editBtn); actions.appendChild(removeBtn);
            header.appendChild(left); header.appendChild(actions);

            const body = document.createElement('div');
            body.className = 'card-body';
            body.style.display = cat.collapsed ? 'none' : 'block';

            // First render category-level items (so they appear at the top)
            (function(){
              const itemsWrap = document.createElement('div');
              (cat.items || []).forEach((it, iidx) => {
                const r = document.createElement('div'); r.className='row';
                const nameInput = document.createElement('input'); nameInput.type='text'; nameInput.value=it.name || ''; nameInput.placeholder='שם נתון';
                const isComputedPack = (cat.name === 'קבועי תמחור תכשיטים' && (it.name||'') === 'סה"כ אריזה');
                const isComputedFixed = (cat.name === 'הוצאות קבועות' && (it.name||'') === 'סה"כ הוצאות קבועות');
                const isComputed = isComputedPack || isComputedFixed;
                
                if (!isComputed) {
                  nameInput.addEventListener('change', () => { it.name = nameInput.value; markDirty(); renderCategories(); });
                } else {
                  nameInput.readOnly = true; 
                  nameInput.title = isComputedPack ? 'נתון מחושב מתוך "פירוט אריזה"' : 'נתון מחושב מסכום הפריטים בקטגוריה';
                }
                const valInput = document.createElement('input'); valInput.type='number'; valInput.step='0.01'; valInput.value = Number(it.value || 0);
                if (!isComputed) {
                  valInput.addEventListener('change', () => { it.value = Number(valInput.value || 0); markDirty(); renderCategories(); });
                } else {
                  valInput.readOnly = true; valInput.title = 'ערך זה מחושב אוטומטית';
                }
                let note;
                if (isComputed) {
                  note = document.createElement('small');
                  note.style.opacity = '0.75';
                  note.textContent = isComputedPack ? 'סכום מחושב מתוך "פירוט אריזה" — לא ניתן לשנות ידנית' : 'סכום מחושב מכל הפריטים בקטגוריה — לא ניתן לשנות ידנית';
                }
                const delBtn = document.createElement('button'); delBtn.className='icon-btn'; delBtn.textContent='🗑️'; delBtn.title='הסר נתון';
                if (!isComputed) {
                  delBtn.addEventListener('click', () => { cat.items.splice(iidx,1); markDirty(); renderCategories(); });
                } else {
                  // hide delete for computed total
                }
                r.appendChild(nameInput); r.appendChild(valInput); if (note) r.appendChild(note); if (!isComputed) r.appendChild(delBtn);
                itemsWrap.appendChild(r);
              });

              const quickRow = document.createElement('div'); quickRow.className='row';
              const qName = document.createElement('input'); qName.type='text'; qName.placeholder='שם נתון';
              const qVal = document.createElement('input'); qVal.type='number'; qVal.step='0.01'; qVal.placeholder='ערך';
              const qAdd = document.createElement('button'); qAdd.className='icon-btn'; qAdd.textContent='➕ הוסף';
              qAdd.addEventListener('click', () => {
                const n = (qName.value||'').trim(); const v = Number(qVal.value||0);
                if (!n) return; cat.items = cat.items || [];
                if (cat.name === 'קבועי תמחור תכשיטים' && n === 'סה"כ אריזה') { alert('"סה"כ אריזה" הוא נתון מחושב ואינו ניתן להוספה ידנית.'); return; }
                if (cat.name === 'הוצאות קבועות' && n === 'סה"כ הוצאות קבועות') { alert('"סה"כ הוצאות קבועות" הוא נתון מחושב ואינו ניתן להוספה ידנית.'); return; }
                cat.items.push({ name:n, value:v });
                qName.value=''; qVal.value='';
                markDirty(); renderCategories();
              });
              quickRow.appendChild(qName); quickRow.appendChild(qVal); quickRow.appendChild(qAdd);

              body.appendChild(itemsWrap);
              body.appendChild(quickRow);
            })();

            // Then render subcategories list
            (cat.subcategories || []).forEach((sub, sidx) => {
              const subcard = document.createElement('div'); subcard.className='subcard';

              // Render a normal sub-header with actions and collapsible behavior for all subcategories
              let subBody = document.createElement('div');
              const subHeader = document.createElement('div'); subHeader.className='sub-header';
              const sLeft = document.createElement('div'); sLeft.style.display='flex'; sLeft.style.alignItems='center'; sLeft.style.gap='8px';
              const subTitle = document.createElement('button'); subTitle.className='icon-btn'; subTitle.type='button'; subTitle.textContent=sub.name || ('תת קטגוריה ' + (sidx+1));
              sLeft.appendChild(subTitle);

              const sActions = document.createElement('div');
              const addItemBtn = document.createElement('button'); addItemBtn.className='icon-btn'; addItemBtn.textContent='➕ נתון'; addItemBtn.title='הוסף נתון';
              addItemBtn.addEventListener('click', () => { sub.items = sub.items || []; sub.items.push({ name: 'שם', value: 0 }); markDirty(); renderCategories(); });
              const editSubBtn = document.createElement('button'); editSubBtn.className='icon-btn'; editSubBtn.textContent='✏️'; editSubBtn.title='עריכת שם תת-קטגוריה';
              editSubBtn.addEventListener('click', () => { const nn = prompt('שם תת-קטגוריה חדש:', sub.name); if (nn && nn.trim()) { sub.name = nn.trim(); markDirty(); renderCategories(); } });
              const delSubBtn = document.createElement('button'); delSubBtn.className='icon-btn'; delSubBtn.textContent='🗑️'; delSubBtn.title='מחיקת תת-קטגוריה';
              delSubBtn.addEventListener('click', () => { if (confirm('למחוק את תת-הקטגוריה?')) { cat.subcategories.splice(sidx,1); markDirty(); renderCategories(); } });
              sActions.appendChild(addItemBtn); sActions.appendChild(editSubBtn); sActions.appendChild(delSubBtn);

              subHeader.appendChild(sLeft); subHeader.appendChild(sActions);
              subcard.appendChild(subHeader);

              subBody.className='card-body'; subBody.style.display = sub.collapsed ? 'none' : 'block';
              subTitle.addEventListener('click', () => { 
                // UI-only toggle; should NOT mark settings as dirty
                sub.collapsed = !sub.collapsed; 
                subBody.style.display = sub.collapsed ? 'none' : 'block'; 
              });

              // Items table (name/value + actions). For 'פירוט אריזה' we also show quantity & manufacturer.
              const itemsWrap = document.createElement('div');
              // Column headers for 'פירוט אריזה'
              if (sub.name === 'פירוט אריזה'){
                const headerRow = document.createElement('div'); headerRow.className='row';
                headerRow.style.fontWeight = 'bold';
                headerRow.style.backgroundColor = '#f8f9fa';
                headerRow.style.padding = '8px 0';
                headerRow.style.borderBottom = '1px solid #ddd';
                
                const hName = document.createElement('div'); 
                hName.textContent = 'שם';
                hName.style.flex = '0 1 220px';
                hName.style.minWidth = '150px';
                
                const hVal = document.createElement('div'); 
                hVal.textContent = 'ערך';
                hVal.style.flex = '0 0 100px';
                hVal.style.minWidth = '90px';
                
                const hQty = document.createElement('div'); 
                hQty.textContent = 'כמות';
                hQty.style.flex = '0 0 100px';
                hQty.style.minWidth = '90px';
                
                const hMfr = document.createElement('div'); 
                hMfr.textContent = 'יצרן';
                hMfr.style.flex = '0 1 220px';
                hMfr.style.minWidth = '150px';
                
                headerRow.appendChild(hName); 
                headerRow.appendChild(hVal); 
                headerRow.appendChild(hQty); 
                headerRow.appendChild(hMfr);
                itemsWrap.appendChild(headerRow);
              }
              (sub.items || []).forEach((it, iidx) => {
                const r = document.createElement('div'); r.className='row';
                const nameInput = document.createElement('input'); nameInput.type='text'; nameInput.value=it.name || ''; nameInput.placeholder='שם נתון';
                const isComputedPackagingTotal = (sub.name === 'קבועי חישוב' && (it.name||'') === 'סה"כ אריזה');
                if (!isComputedPackagingTotal) {
                  nameInput.addEventListener('change', () => { it.name = nameInput.value; markDirty(); renderCategories(); });
                } else {
                  nameInput.readOnly = true; nameInput.title = 'נתון מחושב מתוך "פירוט אריזה"';
                }
                const valInput = document.createElement('input'); valInput.type='number'; valInput.step='0.01'; valInput.value = Number(it.value || 0);
                if (!isComputedPackagingTotal) {
                  valInput.addEventListener('change', () => { it.value = Number(valInput.value || 0); markDirty(); renderCategories(); });
                } else {
                  valInput.readOnly = true; valInput.title = 'ערך זה מחושב אוטומטית';
                }
                let qty, mfr;
                if (sub.name === 'פירוט אריזה'){
                  qty = document.createElement('input'); qty.type='number'; qty.step='1'; qty.placeholder='כמות'; qty.value = Number(it.quantity || 0);
                  qty.addEventListener('change', () => { it.quantity = Number(qty.value || 0); markDirty(); renderCategories(); });
                  mfr = document.createElement('input'); mfr.type='text'; mfr.placeholder='יצרן'; mfr.value = it.manufacturer || '';
                  mfr.addEventListener('change', () => { it.manufacturer = mfr.value; markDirty(); renderCategories(); });
                }
                const delBtn = document.createElement('button'); delBtn.className='icon-btn'; delBtn.textContent='🗑️'; delBtn.title='הסר נתון';
                if (!isComputedPackagingTotal) {
                  delBtn.addEventListener('click', () => { sub.items.splice(iidx,1); markDirty(); renderCategories(); });
                } else {
                  delBtn.disabled = true; delBtn.title = 'לא ניתן למחוק נתון מחושב';
                }
                r.appendChild(nameInput); r.appendChild(valInput); if (qty) r.appendChild(qty); if (mfr) r.appendChild(mfr); r.appendChild(delBtn);
                itemsWrap.appendChild(r);
              });

              // Add quick add row
              const quickRow = document.createElement('div'); quickRow.className='row';
              const qName = document.createElement('input'); qName.type='text'; qName.placeholder='שם נתון';
              const qVal = document.createElement('input'); qVal.type='number'; qVal.step='0.01'; qVal.placeholder='ערך';
              let qQty, qMfr;
              if (sub.name === 'פירוט אריזה'){
                qQty = document.createElement('input'); qQty.type='number'; qQty.step='1'; qQty.placeholder='כמות';
                qMfr = document.createElement('input'); qMfr.type='text'; qMfr.placeholder='יצרן';
              }
              const qAdd = document.createElement('button'); qAdd.className='icon-btn'; qAdd.textContent='➕ הוסף';
              qAdd.addEventListener('click', () => {
                const n = (qName.value||'').trim(); const v = Number(qVal.value||0);
                if (!n) return; sub.items = sub.items || [];
                if (sub.name === 'קבועי חישוב' && n === 'סה"כ אריזה') { alert('"סה"כ אריזה" הוא נתון מחושב ואינו ניתן להוספה ידנית.'); return; }
                const base = { name:n, value:v };
                if (sub.name === 'פירוט אריזה') { base.quantity = Number(qQty?.value || 0); base.manufacturer = (qMfr?.value || '').trim(); }
                sub.items.push(base);
                qName.value=''; qVal.value=''; if (qQty) qQty.value=''; if (qMfr) qMfr.value='';
                markDirty(); renderCategories();
              });
              quickRow.appendChild(qName); quickRow.appendChild(qVal); if (qQty) quickRow.appendChild(qQty); if (qMfr) quickRow.appendChild(qMfr); quickRow.appendChild(qAdd);

              // Footer showing sub total always synced
              const subFooter = document.createElement('div'); subFooter.style.display='flex'; subFooter.style.justifyContent='space-between'; subFooter.style.gap='8px'; subFooter.style.paddingTop='6px';
              const leftNote = document.createElement('small'); leftNote.style.opacity='0.7'; leftNote.textContent = (sub.name === 'פירוט אריזה') ? 'סה"כ אריזה מסתנכרן אוטומטית לקטגוריה' : '';
              const subTotalPill = document.createElement('span'); subTotalPill.className='sum-badge'; subTotalPill.textContent='₪' + subSum(sub).toFixed(2);
              subFooter.appendChild(leftNote); subFooter.appendChild(subTotalPill);

              subBody.appendChild(itemsWrap); subBody.appendChild(quickRow); subBody.appendChild(subFooter);
              subcard.appendChild(subBody);
              body.appendChild(subcard);
            });


            wrapper.appendChild(header);
            wrapper.appendChild(body);
            container.appendChild(wrapper);
          });
        }

        function attachHandlers(){
          const addBtn = document.getElementById('addCategoryBtn');
          if (addBtn) {
            addBtn.addEventListener('click', () => {
              const name = prompt('שם קטגוריה חדשה:');
              if (!name || !name.trim()) return;
              const categories = getCategoriesForEdit();
              categories.push({ name: name.trim(), collapsed: true, subcategories: [] });
              markDirty();
              renderCategories();
            });
          }
          const resetBtn = document.getElementById('resetCategoriesBtn');
          if (resetBtn) {
            resetBtn.addEventListener('click', () => {
              if (!confirm('לאפס את כל הקטגוריות לברירת המחדל? פעולה זו תשמור על נתונים אחרים.')) return;
              // Clear draft & dirty state so the UI reflects the new defaults
              __categoriesDraft = null;
              setSettingsDirty(false);
              const s = getSettingsSafe();
              if (s && typeof s === 'object') { delete s.categories; }
              setSettingsSafe(s || {});
              // לאחר מחיקה, הרנדר יטען את ברירות המחדל ויבצע סינכרון אריזה
              renderCategories();
              // אינדיקציה קלה למשתמש
              try { const ok = document.getElementById('settingsSaved'); if (ok) { ok.style.display='inline'; setTimeout(()=>ok.style.display='none', 1200); } } catch {}
            });
          }
          // Save/Cancel buttons
          const saveBtn = document.getElementById('saveSettingsBtn');
          if (saveBtn) {
            saveBtn.addEventListener('click', () => {
              commitCategories();
            });
          }
          const cancelBtn = document.getElementById('cancelSettingsBtn');
          if (cancelBtn) {
            cancelBtn.addEventListener('click', () => {
              if (!__settingsDirty) return; // nothing to do
              const ok = confirm('לבטל את כל השינויים שלא נשמרו?');
              if (!ok) return;
              discardCategoryChanges();
            });
          }
        }

        // Safe open for Settings that does not assume a nav-tab exists
        window.openSettings = function(){
          try {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            const sec = document.getElementById('settings');
            if (sec) sec.classList.add('active');
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
          } catch {}
        };

        function pinToSettings(){ openSettings(); }

        // Intercept tab switching to warn about unsaved settings
        (function(){
          const originalSwitchTab = window.switchTab;
          window.switchTab = function(target){
            try {
              if (__settingsDirty) {
                const ok = confirm('יש שינויים שלא נשמרו. אם תמשיך, השינויים יבוטלו. להמשיך?');
                if (!ok) { pinToSettings(); return; }
                // Discard draft explicitly as per prompt requirement
                discardCategoryChanges();
              }
            } catch {}
            if (typeof originalSwitchTab === 'function') return originalSwitchTab(target);
          };
        })();

        window.addEventListener('load', function(){
          try { if (typeof initializeSettings === 'function') initializeSettings(); } catch {}
          ensureDefaultCategories();
          renderCategories();
          attachHandlers();
          pinToSettings();
        });
      })();
    </script>
    <!-- Bulk Product Import Script -->
    <script src="bulk_product_import.js"></script>
    <!-- Direct MongoDB Import Script -->
    <script src="data/import/import-to-mongodb.js"></script>
</body>
</html>